import {getRemoteExampleVideo} from '@remotion/example-videos';
import {beforeAll, expect, test} from 'bun:test';
import {mediaParserController} from '../controller/media-parser-controller';
import {nodeReader} from '../node';
import {parseMedia} from '../parse-media';

beforeAll(async () => {
	await getRemoteExampleVideo('tsKeyframes');
});

test('Should return keyframes', async () => {
	let keyframes = 0;

	const controller = mediaParserController();

	const {slowKeyframes} = await parseMedia({
		src: await getRemoteExampleVideo('tsKeyframes'),
		fields: {
			// TODO: Test only works because of
			// 				if (fields.slowKeyframes && videoSample.type === 'key') {
			// in sample-callbacks.ts
			slowKeyframes: true,
		},
		onVideoTrack: () => {
			return (sample) => {
				if (sample.type === 'key') {
					keyframes++;
					if (sample.timestamp === 2902900 && keyframes === 4) {
						controller._experimentalSeek({
							type: 'byte',
							byte: 564,
						});
					}
				}
			};
		},
		controller,
		reader: nodeReader,
		acknowledgeRemotionLicense: true,
	});

	expect(keyframes).toBe(78);
	expect(slowKeyframes).toEqual([
		{
			decodingTimeInSeconds: 0,
			positionInBytes: 564,
			presentationTimeInSeconds: 0,
			sizeInBytes: 8059,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 0.9676333333333332,
			positionInBytes: 150212,
			presentationTimeInSeconds: 0.9676333333333332,
			sizeInBytes: 9637,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 1.9352666666666665,
			positionInBytes: 239324,
			presentationTimeInSeconds: 1.9352666666666665,
			sizeInBytes: 9980,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 2.9029,
			positionInBytes: 440860,
			presentationTimeInSeconds: 2.9029,
			sizeInBytes: 28180,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 3.870533333333333,
			positionInBytes: 529220,
			presentationTimeInSeconds: 3.870533333333333,
			sizeInBytes: 1182,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 4.838166666666666,
			positionInBytes: 609872,
			presentationTimeInSeconds: 4.838166666666666,
			sizeInBytes: 8020,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 5.8058,
			positionInBytes: 996400,
			presentationTimeInSeconds: 5.8058,
			sizeInBytes: 28103,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 6.773433333333333,
			positionInBytes: 1413196,
			presentationTimeInSeconds: 6.773433333333333,
			sizeInBytes: 39511,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 7.741066666666666,
			positionInBytes: 1829616,
			presentationTimeInSeconds: 7.741066666666666,
			sizeInBytes: 56594,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 8.7087,
			positionInBytes: 2305632,
			presentationTimeInSeconds: 8.7087,
			sizeInBytes: 205958,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 9.676333333333332,
			positionInBytes: 2682948,
			presentationTimeInSeconds: 9.676333333333332,
			sizeInBytes: 292586,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 10.643966666666666,
			positionInBytes: 3094104,
			presentationTimeInSeconds: 10.643966666666666,
			sizeInBytes: 232340,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 11.6116,
			positionInBytes: 3502440,
			presentationTimeInSeconds: 11.6116,
			sizeInBytes: 235002,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 12.579233333333333,
			positionInBytes: 3899872,
			presentationTimeInSeconds: 12.579233333333333,
			sizeInBytes: 241862,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 13.546866666666666,
			positionInBytes: 4297304,
			presentationTimeInSeconds: 13.546866666666666,
			sizeInBytes: 224911,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 14.5145,
			positionInBytes: 4725192,
			presentationTimeInSeconds: 14.5145,
			sizeInBytes: 257194,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 15.482133333333332,
			positionInBytes: 5149320,
			presentationTimeInSeconds: 15.482133333333332,
			sizeInBytes: 273245,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 16.449766666666665,
			positionInBytes: 5536036,
			presentationTimeInSeconds: 16.449766666666665,
			sizeInBytes: 276091,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 17.4174,
			positionInBytes: 5943620,
			presentationTimeInSeconds: 17.4174,
			sizeInBytes: 279628,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 18.385033333333332,
			positionInBytes: 6350640,
			presentationTimeInSeconds: 18.385033333333332,
			sizeInBytes: 239275,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 19.352666666666664,
			positionInBytes: 6778340,
			presentationTimeInSeconds: 19.352666666666664,
			sizeInBytes: 257001,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 20.3203,
			positionInBytes: 7168252,
			presentationTimeInSeconds: 20.3203,
			sizeInBytes: 275678,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 21.28793333333333,
			positionInBytes: 7553840,
			presentationTimeInSeconds: 21.28793333333333,
			sizeInBytes: 277972,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 22.255566666666663,
			positionInBytes: 8019328,
			presentationTimeInSeconds: 22.255566666666663,
			sizeInBytes: 234417,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 23.2232,
			positionInBytes: 8395328,
			presentationTimeInSeconds: 23.2232,
			sizeInBytes: 253421,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 24.190833333333334,
			positionInBytes: 8805168,
			presentationTimeInSeconds: 24.190833333333334,
			sizeInBytes: 257122,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 25.158466666666666,
			positionInBytes: 9214256,
			presentationTimeInSeconds: 25.158466666666666,
			sizeInBytes: 240869,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 26.1261,
			positionInBytes: 9648724,
			presentationTimeInSeconds: 26.1261,
			sizeInBytes: 216718,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 27.093733333333333,
			positionInBytes: 10048788,
			presentationTimeInSeconds: 27.093733333333333,
			sizeInBytes: 257607,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 28.061366666666665,
			positionInBytes: 10434188,
			presentationTimeInSeconds: 28.061366666666665,
			sizeInBytes: 280963,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 29.029,
			positionInBytes: 10828424,
			presentationTimeInSeconds: 29.029,
			sizeInBytes: 242655,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 29.99663333333333,
			positionInBytes: 11248604,
			presentationTimeInSeconds: 29.99663333333333,
			sizeInBytes: 276702,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 30.964266666666663,
			positionInBytes: 11667468,
			presentationTimeInSeconds: 30.964266666666663,
			sizeInBytes: 262249,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 31.9319,
			positionInBytes: 12095356,
			presentationTimeInSeconds: 31.9319,
			sizeInBytes: 296756,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 32.89953333333333,
			positionInBytes: 12516288,
			presentationTimeInSeconds: 32.89953333333333,
			sizeInBytes: 252601,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 33.86716666666666,
			positionInBytes: 12977828,
			presentationTimeInSeconds: 33.86716666666666,
			sizeInBytes: 252576,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 34.8348,
			positionInBytes: 13350256,
			presentationTimeInSeconds: 34.8348,
			sizeInBytes: 274665,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 35.802433333333326,
			positionInBytes: 13750132,
			presentationTimeInSeconds: 35.802433333333326,
			sizeInBytes: 277128,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 36.770066666666665,
			positionInBytes: 14152264,
			presentationTimeInSeconds: 36.770066666666665,
			sizeInBytes: 237565,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 37.7377,
			positionInBytes: 14557968,
			presentationTimeInSeconds: 37.7377,
			sizeInBytes: 236077,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 38.70533333333333,
			positionInBytes: 14948632,
			presentationTimeInSeconds: 38.70533333333333,
			sizeInBytes: 275561,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 39.67296666666667,
			positionInBytes: 15333468,
			presentationTimeInSeconds: 39.67296666666667,
			sizeInBytes: 277656,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 40.6406,
			positionInBytes: 15772072,
			presentationTimeInSeconds: 40.6406,
			sizeInBytes: 232832,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 41.60823333333333,
			positionInBytes: 16236432,
			presentationTimeInSeconds: 41.60823333333333,
			sizeInBytes: 252183,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 42.57586666666666,
			positionInBytes: 16600776,
			presentationTimeInSeconds: 42.57586666666666,
			sizeInBytes: 236145,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 43.5435,
			positionInBytes: 16995952,
			presentationTimeInSeconds: 43.5435,
			sizeInBytes: 239086,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 44.511133333333326,
			positionInBytes: 17406544,
			presentationTimeInSeconds: 44.511133333333326,
			sizeInBytes: 254543,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 45.478766666666665,
			positionInBytes: 17813752,
			presentationTimeInSeconds: 45.478766666666665,
			sizeInBytes: 235436,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 46.4464,
			positionInBytes: 18219456,
			presentationTimeInSeconds: 46.4464,
			sizeInBytes: 240939,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 47.41403333333333,
			positionInBytes: 18618956,
			presentationTimeInSeconds: 47.41403333333333,
			sizeInBytes: 242277,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 48.38166666666667,
			positionInBytes: 19021652,
			presentationTimeInSeconds: 48.38166666666667,
			sizeInBytes: 221857,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 49.3493,
			positionInBytes: 19418896,
			presentationTimeInSeconds: 49.3493,
			sizeInBytes: 222941,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 50.31693333333333,
			positionInBytes: 19834940,
			presentationTimeInSeconds: 50.31693333333333,
			sizeInBytes: 247895,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 51.28456666666666,
			positionInBytes: 20253804,
			presentationTimeInSeconds: 51.28456666666666,
			sizeInBytes: 228790,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 52.2522,
			positionInBytes: 20678120,
			presentationTimeInSeconds: 52.2522,
			sizeInBytes: 233184,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 53.21983333333333,
			positionInBytes: 21106384,
			presentationTimeInSeconds: 53.21983333333333,
			sizeInBytes: 212901,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 54.187466666666666,
			positionInBytes: 21510020,
			presentationTimeInSeconds: 54.187466666666666,
			sizeInBytes: 234257,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 55.1551,
			positionInBytes: 21923056,
			presentationTimeInSeconds: 55.1551,
			sizeInBytes: 218067,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 56.12273333333333,
			positionInBytes: 22349440,
			presentationTimeInSeconds: 56.12273333333333,
			sizeInBytes: 200528,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 57.09036666666666,
			positionInBytes: 22730516,
			presentationTimeInSeconds: 57.09036666666666,
			sizeInBytes: 237920,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 58.058,
			positionInBytes: 23116292,
			presentationTimeInSeconds: 58.058,
			sizeInBytes: 282736,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 59.02563333333333,
			positionInBytes: 23574260,
			presentationTimeInSeconds: 59.02563333333333,
			sizeInBytes: 176187,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 59.99326666666666,
			positionInBytes: 24044824,
			presentationTimeInSeconds: 59.99326666666666,
			sizeInBytes: 248488,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 60.9609,
			positionInBytes: 24582128,
			presentationTimeInSeconds: 60.9609,
			sizeInBytes: 4803,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 61.92853333333333,
			positionInBytes: 24709780,
			presentationTimeInSeconds: 61.92853333333333,
			sizeInBytes: 9567,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 62.896166666666666,
			positionInBytes: 24805284,
			presentationTimeInSeconds: 62.896166666666666,
			sizeInBytes: 10118,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 63.8638,
			positionInBytes: 24906052,
			presentationTimeInSeconds: 63.8638,
			sizeInBytes: 10423,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 64.83143333333332,
			positionInBytes: 25012272,
			presentationTimeInSeconds: 64.83143333333332,
			sizeInBytes: 9403,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 65.79906666666666,
			positionInBytes: 25113416,
			presentationTimeInSeconds: 65.79906666666666,
			sizeInBytes: 9763,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 66.7667,
			positionInBytes: 25239752,
			presentationTimeInSeconds: 66.7667,
			sizeInBytes: 1231,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 67.73433333333332,
			positionInBytes: 25317208,
			presentationTimeInSeconds: 67.73433333333332,
			sizeInBytes: 10792,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 68.70196666666668,
			positionInBytes: 25417976,
			presentationTimeInSeconds: 68.70196666666668,
			sizeInBytes: 13681,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 69.6696,
			positionInBytes: 25472308,
			presentationTimeInSeconds: 69.6696,
			sizeInBytes: 13681,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 70.63723333333333,
			positionInBytes: 25591688,
			presentationTimeInSeconds: 70.63723333333333,
			sizeInBytes: 9334,
			trackId: 258,
		},
		{
			decodingTimeInSeconds: 71.60486666666665,
			positionInBytes: 25650156,
			presentationTimeInSeconds: 71.60486666666665,
			sizeInBytes: 1182,
			trackId: 258,
		},
	]);
});
