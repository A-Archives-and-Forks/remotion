import {RenderInternals} from '@remotion/renderer';
import {readFileSync} from 'fs';
import path from 'path';
import {afterAll, expect, test} from 'vitest';
import {deleteRender} from '../../../api/delete-render';
import {rendersPrefix} from '../../../defaults';
import {lambdaLs} from '../../../functions/helpers/io';
import {simulateLambdaRender} from '../simulate-lambda-render';

afterAll(async () => {
	await RenderInternals.killAllBrowsers();
});

test('Should make seamless audio', async () => {
	const {close, file, progress, renderId} = await simulateLambdaRender({
		codec: 'aac',
		composition: 'framer',
		frameRange: [100, 200],
		imageFormat: 'png',
		logLevel: 'error',
		region: 'eu-central-1',
	});

	const wav = path.join(process.cwd(), 'test.wav');

	await RenderInternals.callFf({
		bin: 'ffmpeg',
		args: ['-i', '-', '-y', wav],
		options: {
			stdin: file,
		},
		indent: false,
		binariesDirectory: null,
		cancelSignal: undefined,
		logLevel: 'info',
	});

	const waveForm = readFileSync(wav);
	const buf = waveForm.subarray(100000, 100000 + 2000);

	const files = await lambdaLs({
		bucketName: progress.outBucket as string,
		region: 'eu-central-1',
		expectedBucketOwner: 'abc',
		prefix: rendersPrefix(renderId),
	});

	expect(files.length).toBe(8);

	await deleteRender({
		bucketName: progress.outBucket as string,
		region: 'eu-central-1',
		renderId,
	});

	const expectFiles = await lambdaLs({
		bucketName: progress.outBucket as string,
		region: 'eu-central-1',
		expectedBucketOwner: 'abc',
		prefix: rendersPrefix(renderId),
	});

	expect(expectFiles.length).toBe(0);

	await close();

	expect(buf).toEqual(
		Buffer.from([
			179, 244, 204, 244, 204, 244, 21, 245, 21, 245, 143, 245, 143, 245, 55,
			246, 55, 246, 9, 247, 9, 247, 2, 248, 2, 248, 30, 249, 30, 249, 88, 250,
			88, 250, 172, 251, 172, 251, 18, 253, 18, 253, 133, 254, 133, 254, 255,
			255, 255, 255, 120, 1, 120, 1, 235, 2, 235, 2, 81, 4, 81, 4, 165, 5, 165,
			5, 223, 6, 223, 6, 252, 7, 252, 7, 246, 8, 246, 8, 200, 9, 200, 9, 111,
			10, 111, 10, 233, 10, 233, 10, 50, 11, 50, 11, 75, 11, 75, 11, 51, 11, 51,
			11, 233, 10, 233, 10, 112, 10, 112, 10, 200, 9, 200, 9, 246, 8, 246, 8,
			253, 7, 253, 7, 224, 6, 224, 6, 166, 5, 166, 5, 83, 4, 83, 4, 237, 2, 237,
			2, 121, 1, 121, 1, 0, 0, 0, 0, 134, 254, 134, 254, 19, 253, 19, 253, 173,
			251, 173, 251, 90, 250, 90, 250, 30, 249, 30, 249, 2, 248, 2, 248, 9, 247,
			9, 247, 54, 246, 54, 246, 142, 245, 142, 245, 20, 245, 20, 245, 203, 244,
			203, 244, 178, 244, 178, 244, 202, 244, 202, 244, 20, 245, 20, 245, 141,
			245, 141, 245, 53, 246, 53, 246, 7, 247, 7, 247, 1, 248, 1, 248, 29, 249,
			29, 249, 88, 250, 88, 250, 172, 251, 172, 251, 17, 253, 17, 253, 132, 254,
			132, 254, 254, 255, 254, 255, 120, 1, 120, 1, 235, 2, 235, 2, 82, 4, 82,
			4, 165, 5, 165, 5, 224, 6, 224, 6, 253, 7, 253, 7, 247, 8, 247, 8, 201, 9,
			201, 9, 112, 10, 112, 10, 234, 10, 234, 10, 52, 11, 52, 11, 76, 11, 76,
			11, 52, 11, 52, 11, 234, 10, 234, 10, 113, 10, 113, 10, 202, 9, 202, 9,
			247, 8, 247, 8, 254, 7, 254, 7, 225, 6, 225, 6, 166, 5, 166, 5, 83, 4, 83,
			4, 237, 2, 237, 2, 122, 1, 122, 1, 0, 0, 0, 0, 134, 254, 134, 254, 19,
			253, 19, 253, 172, 251, 172, 251, 89, 250, 89, 250, 30, 249, 30, 249, 1,
			248, 1, 248, 7, 247, 7, 247, 52, 246, 52, 246, 141, 245, 141, 245, 20,
			245, 20, 245, 201, 244, 201, 244, 177, 244, 177, 244, 201, 244, 201, 244,
			19, 245, 19, 245, 141, 245, 141, 245, 52, 246, 52, 246, 6, 247, 6, 247, 0,
			248, 0, 248, 28, 249, 28, 249, 87, 250, 87, 250, 171, 251, 171, 251, 18,
			253, 18, 253, 134, 254, 134, 254, 255, 255, 255, 255, 120, 1, 120, 1, 236,
			2, 236, 2, 82, 4, 82, 4, 166, 5, 166, 5, 224, 6, 224, 6, 253, 7, 253, 7,
			247, 8, 247, 8, 201, 9, 201, 9, 113, 10, 113, 10, 235, 10, 235, 10, 53,
			11, 53, 11, 78, 11, 78, 11, 54, 11, 54, 11, 236, 10, 236, 10, 113, 10,
			113, 10, 202, 9, 202, 9, 248, 8, 248, 8, 253, 7, 253, 7, 225, 6, 225, 6,
			167, 5, 167, 5, 83, 4, 83, 4, 236, 2, 236, 2, 121, 1, 121, 1, 255, 255,
			255, 255, 134, 254, 134, 254, 18, 253, 18, 253, 171, 251, 171, 251, 87,
			250, 87, 250, 29, 249, 29, 249, 0, 248, 0, 248, 7, 247, 7, 247, 53, 246,
			53, 246, 142, 245, 142, 245, 20, 245, 20, 245, 202, 244, 202, 244, 177,
			244, 177, 244, 202, 244, 202, 244, 19, 245, 19, 245, 141, 245, 141, 245,
			53, 246, 53, 246, 7, 247, 7, 247, 1, 248, 1, 248, 29, 249, 29, 249, 88,
			250, 88, 250, 172, 251, 172, 251, 18, 253, 18, 253, 134, 254, 134, 254,
			255, 255, 255, 255, 122, 1, 122, 1, 237, 2, 237, 2, 83, 4, 83, 4, 167, 5,
			167, 5, 226, 6, 226, 6, 255, 7, 255, 7, 248, 8, 248, 8, 202, 9, 202, 9,
			114, 10, 114, 10, 236, 10, 236, 10, 53, 11, 53, 11, 77, 11, 77, 11, 52,
			11, 52, 11, 234, 10, 234, 10, 112, 10, 112, 10, 200, 9, 200, 9, 246, 8,
			246, 8, 252, 7, 252, 7, 223, 6, 223, 6, 165, 5, 165, 5, 81, 4, 81, 4, 234,
			2, 234, 2, 120, 1, 120, 1, 254, 255, 254, 255, 132, 254, 132, 254, 17,
			253, 17, 253, 171, 251, 171, 251, 87, 250, 87, 250, 28, 249, 28, 249, 0,
			248, 0, 248, 6, 247, 6, 247, 52, 246, 52, 246, 141, 245, 141, 245, 19,
			245, 19, 245, 201, 244, 201, 244, 177, 244, 177, 244, 203, 244, 203, 244,
			21, 245, 21, 245, 142, 245, 142, 245, 54, 246, 54, 246, 9, 247, 9, 247, 2,
			248, 2, 248, 32, 249, 32, 249, 90, 250, 90, 250, 173, 251, 173, 251, 20,
			253, 20, 253, 135, 254, 135, 254, 0, 0, 0, 0, 122, 1, 122, 1, 237, 2, 237,
			2, 84, 4, 84, 4, 167, 5, 167, 5, 226, 6, 226, 6, 254, 7, 254, 7, 248, 8,
			248, 8, 202, 9, 202, 9, 113, 10, 113, 10, 234, 10, 234, 10, 51, 11, 51,
			11, 76, 11, 76, 11, 51, 11, 51, 11, 233, 10, 233, 10, 112, 10, 112, 10,
			199, 9, 199, 9, 245, 8, 245, 8, 252, 7, 252, 7, 222, 6, 222, 6, 164, 5,
			164, 5, 81, 4, 81, 4, 234, 2, 234, 2, 119, 1, 119, 1, 254, 255, 254, 255,
			131, 254, 131, 254, 16, 253, 16, 253, 171, 251, 171, 251, 87, 250, 87,
			250, 29, 249, 29, 249, 0, 248, 0, 248, 7, 247, 7, 247, 53, 246, 53, 246,
			141, 245, 141, 245, 20, 245, 20, 245, 202, 244, 202, 244, 179, 244, 179,
			244, 204, 244, 204, 244, 21, 245, 21, 245, 143, 245, 143, 245, 55, 246,
			55, 246, 9, 247, 9, 247, 3, 248, 3, 248, 32, 249, 32, 249, 91, 250, 91,
			250, 174, 251, 174, 251, 20, 253, 20, 253, 136, 254, 136, 254, 2, 0, 2, 0,
			123, 1, 123, 1, 238, 2, 238, 2, 84, 4, 84, 4, 167, 5, 167, 5, 225, 6, 225,
			6, 253, 7, 253, 7, 247, 8, 247, 8, 201, 9, 201, 9, 112, 10, 112, 10, 233,
			10, 233, 10, 50, 11, 50, 11, 75, 11, 75, 11, 50, 11, 50, 11, 232, 10, 232,
			10, 111, 10, 111, 10, 200, 9, 200, 9, 245, 8, 245, 8, 252, 7, 252, 7, 223,
			6, 223, 6, 165, 5, 165, 5, 81, 4, 81, 4, 234, 2, 234, 2, 120, 1, 120, 1,
			254, 255, 254, 255, 132, 254, 132, 254, 17, 253, 17, 253, 171, 251, 171,
			251, 88, 250, 88, 250, 30, 249, 30, 249, 1, 248, 1, 248, 8, 247, 8, 247,
			54, 246, 54, 246, 142, 245, 142, 245, 21, 245, 21, 245, 203, 244, 203,
			244, 179, 244, 179, 244, 203, 244, 203, 244, 21, 245, 21, 245, 143, 245,
			143, 245, 55, 246, 55, 246, 9, 247, 9, 247, 3, 248, 3, 248, 31, 249, 31,
			249, 90, 250, 90, 250, 173, 251, 173, 251, 18, 253, 18, 253, 133, 254,
			133, 254, 255, 255, 255, 255, 120, 1, 120, 1, 236, 2, 236, 2, 82, 4, 82,
			4, 165, 5, 165, 5, 224, 6, 224, 6, 252, 7, 252, 7, 246, 8, 246, 8, 200, 9,
			200, 9, 111, 10, 111, 10, 233, 10, 233, 10, 51, 11, 51, 11, 75, 11, 75,
			11, 50, 11, 50, 11, 233, 10, 233, 10, 111, 10, 111, 10, 199, 9, 199, 9,
			245, 8, 245, 8, 252, 7, 252, 7, 223, 6, 223, 6, 165, 5, 165, 5, 82, 4, 82,
			4, 236, 2, 236, 2, 121, 1, 121, 1, 255, 255, 255, 255, 134, 254, 134, 254,
			19, 253, 19, 253, 173, 251, 173, 251, 89, 250, 89, 250, 31, 249, 31, 249,
			2, 248, 2, 248, 9, 247, 9, 247, 54, 246, 54, 246, 143, 245, 143, 245, 21,
			245, 21, 245, 203, 244, 203, 244, 178, 244, 178, 244, 203, 244, 203, 244,
			20, 245, 20, 245, 142, 245, 142, 245, 53, 246, 53, 246, 7, 247, 7, 247, 1,
			248, 1, 248, 30, 249, 30, 249, 87, 250, 87, 250, 171, 251, 171, 251, 17,
			253, 17, 253, 132, 254, 132, 254, 254, 255, 254, 255, 119, 1, 119, 1, 235,
			2, 235, 2, 82, 4, 82, 4, 164, 5, 164, 5, 223, 6, 223, 6, 252, 7, 252, 7,
			246, 8, 246, 8, 200, 9, 200, 9, 112, 10, 112, 10, 234, 10, 234, 10, 52,
			11, 52, 11, 77, 11, 77, 11, 52, 11, 52, 11, 234, 10, 234, 10, 113, 10,
			113, 10, 201, 9, 201, 9, 247, 8, 247, 8, 254, 7, 254, 7, 225, 6, 225, 6,
			166, 5, 166, 5, 83, 4, 83, 4, 237, 2, 237, 2, 122, 1, 122, 1, 1, 0, 1, 0,
			135, 254, 135, 254, 20, 253, 20, 253, 173, 251, 173, 251, 90, 250, 90,
			250, 31, 249, 31, 249, 2, 248, 2, 248, 9, 247, 9, 247, 54, 246, 54, 246,
			142, 245, 142, 245, 21, 245, 21, 245, 202, 244, 202, 244, 177, 244, 177,
			244, 202, 244, 202, 244, 19, 245, 19, 245, 141, 245, 141, 245, 52, 246,
			52, 246, 6, 247, 6, 247, 255, 247, 255, 247, 28, 249, 28, 249, 87, 250,
			87, 250, 170, 251, 170, 251, 16, 253, 16, 253, 132, 254, 132, 254, 253,
			255, 253, 255, 119, 1, 119, 1, 235, 2, 235, 2, 82, 4, 82, 4, 165, 5, 165,
			5, 224, 6, 224, 6, 253, 7, 253, 7, 247, 8, 247, 8, 201, 9, 201, 9, 113,
			10, 113, 10, 236, 10, 236, 10, 53, 11, 53, 11, 78, 11, 78, 11, 53, 11, 53,
			11, 236, 10, 236, 10, 114, 10, 114, 10, 203, 9, 203, 9, 249, 8, 249, 8,
			255, 7, 255, 7, 226, 6, 226, 6, 168, 5, 168, 5, 84, 4, 84, 4, 238, 2, 238,
			2, 123, 1, 123, 1, 1, 0, 1, 0, 134, 254, 134, 254, 18, 253, 18, 253, 172,
			251, 172, 251, 89, 250, 89, 250, 29, 249, 29, 249, 0, 248, 0, 248, 7, 247,
			7, 247, 52, 246, 52, 246, 140, 245, 140, 245, 18, 245, 18, 245, 201, 244,
			201, 244, 176, 244, 176, 244, 201, 244, 201, 244, 18, 245, 18, 245, 139,
			245, 139, 245, 51, 246, 51, 246, 6, 247, 6, 247, 255, 247, 255, 247, 28,
			249, 28, 249, 86, 250, 86, 250, 170, 251, 170, 251, 17, 253, 17, 253, 132,
			254, 132, 254, 254, 255, 254, 255, 120, 1, 120, 1, 236, 2, 236, 2, 82, 4,
			82, 4, 166, 5, 166, 5, 225, 6, 225, 6, 255, 7, 255, 7, 248, 8, 248, 8,
			203, 9, 203, 9, 115, 10, 115, 10, 236, 10, 236, 10, 53, 11, 53, 11, 79,
			11, 79, 11, 54, 11, 54, 11, 237, 10, 237, 10, 115, 10, 115, 10, 204, 9,
			204, 9, 249, 8, 249, 8, 255, 7, 255, 7, 226, 6, 226, 6, 168, 5, 168, 5,
			84, 4, 84, 4, 237, 2, 237, 2, 121, 1, 121, 1, 255, 255, 255, 255, 133,
			254, 133, 254, 17, 253, 17, 253, 171, 251, 171, 251, 88, 250, 88, 250, 28,
			249, 28, 249, 254, 247, 254, 247, 5, 247, 5, 247, 51, 246, 51, 246, 139,
			245, 139, 245, 17, 245, 17, 245, 200, 244, 200, 244, 176, 244, 176, 244,
			200, 244, 200, 244, 17, 245, 17, 245, 140, 245, 140, 245, 51, 246, 51,
			246, 6, 247, 6, 247, 0, 248, 0, 248, 28, 249, 28, 249, 87, 250, 87, 250,
			172, 251, 172, 251, 18, 253, 18, 253, 134, 254, 134, 254, 0, 0, 0, 0, 122,
			1, 122, 1, 237, 2, 237, 2, 83, 4, 83, 4, 167, 5, 167, 5, 226, 6, 226, 6,
			255, 7, 255, 7, 249, 8, 249, 8, 204, 9,
		]),
	);

	// unlinkSync(wav);
});
