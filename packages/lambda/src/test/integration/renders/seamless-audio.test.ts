import {RenderInternals} from '@remotion/renderer';
import {readFileSync} from 'fs';
import path from 'path';
import {afterAll, expect, test} from 'vitest';
import {deleteRender} from '../../../api/delete-render';
import {rendersPrefix} from '../../../defaults';
import {lambdaLs} from '../../../functions/helpers/io';
import {simulateLambdaRender} from '../simulate-lambda-render';

afterAll(async () => {
	await RenderInternals.killAllBrowsers();
});

test('Should make seamless audio', async () => {
	const {close, file, progress, renderId} = await simulateLambdaRender({
		codec: 'aac',
		composition: 'framer',
		frameRange: [100, 200],
		imageFormat: 'png',
		logLevel: 'error',
		region: 'eu-central-1',
		inputProps: {playbackRate: 2},
	});

	const wav = path.join(process.cwd(), 'test.wav');

	await RenderInternals.callFf({
		bin: 'ffmpeg',
		args: ['-i', '-', '-y', wav],
		options: {
			stdin: file,
		},
		indent: false,
		binariesDirectory: null,
		cancelSignal: undefined,
		logLevel: 'info',
	});

	const waveForm = readFileSync(wav);
	const buf = waveForm.subarray(100000, 100000 + 2000);

	const files = await lambdaLs({
		bucketName: progress.outBucket as string,
		region: 'eu-central-1',
		expectedBucketOwner: 'abc',
		prefix: rendersPrefix(renderId),
	});

	expect(files.length).toBe(8);

	await deleteRender({
		bucketName: progress.outBucket as string,
		region: 'eu-central-1',
		renderId,
	});

	const expectFiles = await lambdaLs({
		bucketName: progress.outBucket as string,
		region: 'eu-central-1',
		expectedBucketOwner: 'abc',
		prefix: rendersPrefix(renderId),
	});

	expect(expectFiles.length).toBe(0);

	await close();

	expect(buf).toEqual(
		Buffer.from([
			58, 245, 254, 243, 254, 243, 203, 242, 203, 242, 164, 241, 164, 241, 138,
			240, 138, 240, 124, 239, 124, 239, 124, 238, 124, 238, 140, 237, 140, 237,
			170, 236, 170, 236, 217, 235, 217, 235, 27, 235, 27, 235, 109, 234, 109,
			234, 208, 233, 208, 233, 72, 233, 72, 233, 211, 232, 211, 232, 113, 232,
			113, 232, 35, 232, 35, 232, 234, 231, 234, 231, 197, 231, 197, 231, 181,
			231, 181, 231, 186, 231, 186, 231, 210, 231, 210, 231, 255, 231, 255, 231,
			65, 232, 65, 232, 151, 232, 151, 232, 1, 233, 1, 233, 126, 233, 126, 233,
			14, 234, 14, 234, 178, 234, 178, 234, 103, 235, 103, 235, 45, 236, 45,
			236, 6, 237, 6, 237, 236, 237, 236, 237, 227, 238, 227, 238, 234, 239,
			234, 239, 252, 240, 252, 240, 28, 242, 28, 242, 72, 243, 72, 243, 126,
			244, 126, 244, 191, 245, 191, 245, 8, 247, 8, 247, 88, 248, 88, 248, 176,
			249, 176, 249, 12, 251, 12, 251, 108, 252, 108, 252, 209, 253, 209, 253,
			53, 255, 53, 255, 156, 0, 156, 0, 2, 2, 2, 2, 101, 3, 101, 3, 199, 4, 199,
			4, 36, 6, 36, 6, 123, 7, 123, 7, 206, 8, 206, 8, 23, 10, 23, 10, 88, 11,
			88, 11, 145, 12, 145, 12, 190, 13, 190, 13, 223, 14, 223, 14, 244, 15,
			244, 15, 252, 16, 252, 16, 244, 17, 244, 17, 222, 18, 222, 18, 183, 19,
			183, 19, 128, 20, 128, 20, 55, 21, 55, 21, 221, 21, 221, 21, 112, 22, 112,
			22, 239, 22, 239, 22, 92, 23, 92, 23, 180, 23, 180, 23, 248, 23, 248, 23,
			40, 24, 40, 24, 67, 24, 67, 24, 74, 24, 74, 24, 60, 24, 60, 24, 26, 24,
			26, 24, 226, 23, 226, 23, 151, 23, 151, 23, 56, 23, 56, 23, 197, 22, 197,
			22, 62, 22, 62, 22, 165, 21, 165, 21, 250, 20, 250, 20, 59, 20, 59, 20,
			109, 19, 109, 19, 143, 18, 143, 18, 159, 17, 159, 17, 161, 16, 161, 16,
			149, 15, 149, 15, 124, 14, 124, 14, 87, 13, 87, 13, 38, 12, 38, 12, 234,
			10, 234, 10, 165, 9, 165, 9, 89, 8, 89, 8, 6, 7, 6, 7, 171, 5, 171, 5, 77,
			4, 77, 4, 235, 2, 235, 2, 133, 1, 133, 1, 32, 0, 32, 0, 186, 254, 186,
			254, 84, 253, 84, 253, 243, 251, 243, 251, 146, 250, 146, 250, 55, 249,
			55, 249, 227, 247, 227, 247, 148, 246, 148, 246, 78, 245, 78, 245, 18,
			244, 18, 244, 222, 242, 222, 242, 182, 241, 182, 241, 156, 240, 156, 240,
			140, 239, 140, 239, 140, 238, 140, 238, 154, 237, 154, 237, 183, 236, 183,
			236, 230, 235, 230, 235, 37, 235, 37, 235, 118, 234, 118, 234, 218, 233,
			218, 233, 79, 233, 79, 233, 217, 232, 217, 232, 118, 232, 118, 232, 38,
			232, 38, 232, 236, 231, 236, 231, 198, 231, 198, 231, 179, 231, 179, 231,
			183, 231, 183, 231, 207, 231, 207, 231, 250, 231, 250, 231, 59, 232, 59,
			232, 143, 232, 143, 232, 249, 232, 249, 232, 117, 233, 117, 233, 4, 234,
			4, 234, 166, 234, 166, 234, 90, 235, 90, 235, 32, 236, 32, 236, 247, 236,
			247, 236, 221, 237, 221, 237, 211, 238, 211, 238, 216, 239, 216, 239, 234,
			240, 234, 240, 10, 242, 10, 242, 54, 243, 54, 243, 106, 244, 106, 244,
			171, 245, 171, 245, 244, 246, 244, 246, 67, 248, 67, 248, 155, 249, 155,
			249, 247, 250, 247, 250, 87, 252, 87, 252, 188, 253, 188, 253, 33, 255,
			33, 255, 136, 0, 136, 0, 238, 1, 238, 1, 81, 3, 81, 3, 179, 4, 179, 4, 17,
			6, 17, 6, 105, 7, 105, 7, 188, 8, 188, 8, 5, 10, 5, 10, 72, 11, 72, 11,
			128, 12, 128, 12, 174, 13, 174, 13, 209, 14, 209, 14, 230, 15, 230, 15,
			238, 16, 238, 16, 233, 17, 233, 17, 210, 18, 210, 18, 173, 19, 173, 19,
			120, 20, 120, 20, 47, 21, 47, 21, 214, 21, 214, 21, 106, 22, 106, 22, 234,
			22, 234, 22, 89, 23, 89, 23, 178, 23, 178, 23, 247, 23, 247, 23, 42, 24,
			42, 24, 69, 24, 69, 24, 77, 24, 77, 24, 66, 24, 66, 24, 31, 24, 31, 24,
			234, 23, 234, 23, 160, 23, 160, 23, 65, 23, 65, 23, 208, 22, 208, 22, 75,
			22, 75, 22, 178, 21, 178, 21, 8, 21, 8, 21, 74, 20, 74, 20, 125, 19, 125,
			19, 159, 18, 159, 18, 176, 17, 176, 17, 180, 16, 180, 16, 168, 15, 168,
			15, 142, 14, 142, 14, 107, 13, 107, 13, 57, 12, 57, 12, 254, 10, 254, 10,
			187, 9, 187, 9, 109, 8, 109, 8, 26, 7, 26, 7, 194, 5, 194, 5, 97, 4, 97,
			4, 255, 2, 255, 2, 155, 1, 155, 1, 52, 0, 52, 0, 206, 254, 206, 254, 105,
			253, 105, 253, 5, 252, 5, 252, 165, 250, 165, 250, 74, 249, 74, 249, 245,
			247, 245, 247, 166, 246, 166, 246, 94, 245, 94, 245, 33, 244, 33, 244,
			237, 242, 237, 242, 196, 241, 196, 241, 168, 240, 168, 240, 152, 239, 152,
			239, 150, 238, 150, 238, 163, 237, 163, 237, 192, 236, 192, 236, 238, 235,
			238, 235, 43, 235, 43, 235, 123, 234, 123, 234, 221, 233, 221, 233, 82,
			233, 82, 233, 218, 232, 218, 232, 118, 232, 118, 232, 37, 232, 37, 232,
			234, 231, 234, 231, 194, 231, 194, 231, 175, 231, 175, 231, 177, 231, 177,
			231, 199, 231, 199, 231, 242, 231, 242, 231, 50, 232, 50, 232, 133, 232,
			133, 232, 237, 232, 237, 232, 104, 233, 104, 233, 246, 233, 246, 233, 152,
			234, 152, 234, 74, 235, 74, 235, 15, 236, 15, 236, 230, 236, 230, 236,
			203, 237, 203, 237, 193, 238, 193, 238, 197, 239, 197, 239, 214, 240, 214,
			240, 245, 241, 245, 241, 33, 243, 33, 243, 85, 244, 85, 244, 150, 245,
			150, 245, 222, 246, 222, 246, 46, 248, 46, 248, 133, 249, 133, 249, 225,
			250, 225, 250, 65, 252, 65, 252, 166, 253, 166, 253, 11, 255, 11, 255,
			114, 0, 114, 0, 216, 1, 216, 1, 60, 3, 60, 3, 159, 4, 159, 4, 253, 5, 253,
			5, 85, 7, 85, 7, 168, 8, 168, 8, 244, 9, 244, 9, 55, 11, 55, 11, 112, 12,
			112, 12, 159, 13, 159, 13, 194, 14, 194, 14, 217, 15, 217, 15, 226, 16,
			226, 16, 222, 17, 222, 17, 201, 18, 201, 18, 165, 19, 165, 19, 113, 20,
			113, 20, 41, 21, 41, 21, 209, 21, 209, 21, 104, 22, 104, 22, 233, 22, 233,
			22, 88, 23, 88, 23, 180, 23, 180, 23, 249, 23, 249, 23, 44, 24, 44, 24,
			74, 24, 74, 24, 82, 24, 82, 24, 72, 24, 72, 24, 40, 24, 40, 24, 242, 23,
			242, 23, 171, 23, 171, 23, 76, 23, 76, 23, 220, 22, 220, 22, 89, 22, 89,
			22, 192, 21, 192, 21, 23, 21, 23, 21, 92, 20, 92, 20, 142, 19, 142, 19,
			178, 18, 178, 18, 196, 17, 196, 17, 199, 16, 199, 16, 190, 15, 190, 15,
			165, 14, 165, 14, 128, 13, 128, 13, 81, 12, 81, 12, 21, 11, 21, 11, 210,
			9, 210, 9, 134, 8, 134, 8, 49, 7, 49, 7, 217, 5, 217, 5, 122, 4, 122, 4,
			23, 3, 23, 3, 179, 1, 179, 1, 76, 0, 76, 0, 229, 254, 229, 254, 126, 253,
			126, 253, 27, 252, 27, 252, 187, 250, 187, 250, 94, 249, 94, 249, 8, 248,
			8, 248, 185, 246, 185, 246, 112, 245, 112, 245, 50, 244, 50, 244, 254,
			242, 254, 242, 212, 241, 212, 241, 182, 240, 182, 240, 166, 239, 166, 239,
			163, 238, 163, 238, 175, 237, 175, 237, 202, 236, 202, 236, 247, 235, 247,
			235, 51, 235, 51, 235, 129, 234, 129, 234, 227, 233, 227, 233, 86, 233,
			86, 233, 220, 232, 220, 232, 120, 232, 120, 232, 37, 232, 37, 232, 232,
			231, 232, 231, 192, 231, 192, 231, 171, 231, 171, 231, 171, 231, 171, 231,
			192, 231, 192, 231, 234, 231, 234, 231, 41, 232, 41, 232, 123, 232, 123,
			232, 225, 232, 225, 232, 91, 233, 91, 233, 232, 233, 232, 233, 136, 234,
			136, 234, 58, 235, 58, 235, 255, 235, 255, 235, 211, 236, 211, 236, 183,
			237, 183, 237, 173, 238, 173, 238, 176, 239, 176, 239, 193, 240, 193, 240,
			224, 241, 224, 241, 9, 243, 9, 243, 62, 244, 62, 244, 126, 245, 126, 245,
			197, 246, 197, 246, 21, 248, 21, 248, 108, 249, 108, 249, 200, 250, 200,
			250, 41, 252, 41, 252, 140, 253, 140, 253, 242, 254, 242, 254, 90, 0, 90,
			0, 191, 1, 191, 1, 36, 3, 36, 3, 136, 4, 136, 4, 229, 5, 229, 5, 63, 7,
			63, 7, 147, 8, 147, 8, 221, 9, 221, 9, 34, 11, 34, 11, 93, 12, 93, 12,
			139, 13, 139, 13, 176, 14, 176, 14, 200, 15, 200, 15, 209, 16, 209, 16,
			207, 17, 207, 17, 187, 18, 187, 18, 152, 19, 152, 19, 101, 20, 101, 20,
			31, 21, 31, 21, 201, 21, 201, 21, 96, 22, 96, 22, 227, 22, 227, 22, 83,
			23, 83, 23, 176, 23, 176, 23, 247, 23, 247, 23, 43, 24, 43, 24, 75, 24,
			75, 24, 86, 24, 86, 24, 75, 24, 75, 24, 44, 24, 44, 24, 250, 23, 250, 23,
			178, 23, 178, 23, 87, 23, 87, 23, 231, 22, 231, 22, 99, 22, 99, 22, 206,
			21, 206, 21, 38, 21, 38, 21, 106, 20, 106, 20, 160, 19, 160, 19, 195, 18,
			195, 18, 213, 17, 213, 17, 219, 16, 219, 16, 209, 15, 209, 15, 185, 14,
			185, 14, 150, 13, 150, 13, 102, 12, 102, 12, 43, 11, 43, 11, 233, 9, 233,
			9, 157, 8, 157, 8, 74, 7, 74, 7, 241, 5, 241, 5, 146, 4, 146, 4, 48, 3,
			48, 3, 203, 1, 203, 1, 101, 0, 101, 0, 254, 254, 254, 254, 151, 253, 151,
			253, 52, 252, 52, 252, 212, 250, 212, 250, 118, 249, 118, 249, 33, 248,
			33, 248, 209, 246, 209, 246, 134, 245, 134, 245, 72, 244, 72, 244, 20,
			243, 20, 243, 232, 241, 232, 241, 202, 240, 202, 240, 185, 239, 185, 239,
			180, 238, 180, 238, 191, 237, 191, 237, 218, 236, 218, 236, 4, 236, 4,
			236, 64, 235, 64, 235, 141, 234, 141, 234, 236, 233, 236, 233, 94, 233,
			94, 233, 228, 232, 228, 232, 125, 232, 125, 232, 42, 232, 42, 232, 235,
			231, 235, 231, 193, 231, 193, 231, 171, 231, 171, 231, 170, 231, 170, 231,
			190, 231, 190, 231, 230, 231, 230, 231, 34, 232, 34, 232, 115, 232, 115,
			232, 217, 232, 217, 232, 81, 233, 81, 233, 221, 233, 221, 233, 124, 234,
			124, 234, 44, 235, 44, 235, 238, 235, 238, 235, 195, 236, 195, 236, 165,
			237, 165, 237, 154, 238, 154, 238, 156, 239, 156, 239, 171, 240, 171, 240,
			202, 241, 202, 241, 243, 242, 243, 242, 38, 244, 38, 244, 102, 245, 102,
			245, 173, 246, 173, 246, 251, 247, 251, 247, 83, 249, 83, 249, 174, 250,
			174, 250, 13, 252, 13, 252, 115, 253, 115, 253, 216, 254, 216, 254, 62, 0,
			62, 0, 166, 1, 166, 1, 11, 3, 11, 3, 109, 4, 109, 4, 204, 5, 204, 5, 38,
			7, 38, 7, 122, 8, 122, 8, 199, 9, 199, 9, 11, 11, 11, 11, 71, 12, 71, 12,
			119, 13, 119, 13, 155, 14, 155, 14, 181, 15, 181, 15, 193, 16, 193, 16,
			189, 17, 189, 17, 172, 18, 172, 18, 138, 19, 138, 19, 87, 20,
		]),
	);
});
